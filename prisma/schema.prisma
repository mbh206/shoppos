generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String      @id @default(cuid())
  email          String      @unique
  name           String?
  role           UserRole
  hashedPassword String
  
  // Employee fields
  employeeId     String?     @unique
  hireDate       DateTime?
  position       String?
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  // Relations
  ordersOpened   Order[]     @relation("OpenedBy")
  ordersClosed   Order[]     @relation("ClosedBy")
  profile        EmployeeProfile?
  timeEntries    TimeEntry[]
  adjustedEntries TimeEntry[] @relation("AdjustedBy")
  rentalsCheckedOut GameRental[] @relation("CheckOutStaff")
  rentalsCheckedIn  GameRental[] @relation("CheckInStaff")
}

enum UserRole {
  admin
  manager
  employee
}

model Customer {
  id               String        @id @default(cuid())
  squareCustomerId String?       @unique
  firstName        String?
  lastName         String?
  displayName      String?
  phone            String?
  email            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  orders           Order[]
  paidOrders       Order[]       @relation("Payer")
  seatSessions     SeatSession[]
  rentals          Rental[]
  gameRentals      GameRental[]
  eventTickets     EventTicket[]
}

model Table {
  id           String      @id @default(cuid())
  name         String
  capacity     Int
  status       TableStatus @default(available)
  floor        Int         @default(1)
  zone         String      @default("main")
  shape        TableShape  @default(rectangle)
  posX         Int         @default(0)
  posY         Int         @default(0)
  width        Int         @default(100)
  height       Int         @default(100)
  rotation     Int         @default(0)
  isGroupable  Boolean     @default(false)
  maxGroupSize Int?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  seats        Seat[]
  gameSessions TableGameSession[]

  @@index([floor, zone])
}

enum TableStatus {
  available
  seated
  dirty
  reserved
  offline
}

enum TableShape {
  rectangle
  circle
  booth
  bar
}

model Seat {
  id           String        @id @default(cuid())
  tableId      String
  number       Int
  status       SeatStatus    @default(open)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  table        Table         @relation(fields: [tableId], references: [id], onDelete: Cascade)
  seatSessions SeatSession[]

  @@unique([tableId, number])
}

enum SeatStatus {
  open
  occupied
  dirty
  closed
}

model Order {
  id              String           @id @default(cuid())
  squareOrderId   String?          @unique
  channel         OrderChannel
  status          OrderStatus
  customerId      String?
  payerCustomerId String?
  openedByUserId  String
  closedByUserId  String?
  openedAt        DateTime         @default(now())
  closedAt        DateTime?
  notes           String?
  meta            Json?
  customer        Customer?        @relation(fields: [customerId], references: [id])
  payer           Customer?        @relation("Payer", fields: [payerCustomerId], references: [id])
  openedBy        User             @relation("OpenedBy", fields: [openedByUserId], references: [id])
  closedBy        User?            @relation("ClosedBy", fields: [closedByUserId], references: [id])
  items           OrderItem[]
  seatSessions    SeatSession[]
  events          OrderEvent[]
  payments        PaymentAttempt[]
  eventTickets    EventTicket[]
  rentalCheckouts GameRental[]    @relation("RentalCheckoutOrder")
  rentalReturns   GameRental[]    @relation("RentalReturnOrder")

  @@index([status, channel])
  @@index([openedAt])
  @@index([customerId])
}

enum OrderChannel {
  in_store
  online_pickup
  online_paid
}

enum OrderStatus {
  open
  awaiting_payment
  paid
  canceled
  refunded
}

model OrderItem {
  id                    String        @id @default(cuid())
  orderId               String
  kind                  OrderItemKind
  name                  String
  squareCatalogObjectId String?
  qty                   Int
  unitPriceMinor        Int
  taxMinor              Int           @default(0)
  totalMinor            Int
  meta                  Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  order                 Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

enum OrderItemKind {
  retail
  fnb
  seat_time
  rental
  event
  rental_deposit
  rental_fee
}

model SeatSession {
  id            String    @id @default(cuid())
  seatId        String
  orderId       String
  customerId    String?
  startedAt     DateTime? // Made optional for no-timer sessions
  endedAt       DateTime?
  billedMinutes Int       @default(0)
  billedItemId  String?
  meta          Json?
  seat          Seat      @relation(fields: [seatId], references: [id], onDelete: Cascade)
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customer      Customer? @relation(fields: [customerId], references: [id])

  @@index([seatId, orderId])
  @@index([startedAt])
}

model InventoryReservation {
  id                String            @id @default(cuid())
  squareVariationId String
  qty               Int
  reason            ReservationReason
  expiresAt         DateTime?
  linkedOrderId     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([squareVariationId])
  @@index([expiresAt])
}

enum ReservationReason {
  pickup
  rental
}

model Rental {
  id                String       @id @default(cuid())
  squareVariationId String
  customerId        String
  outAt             DateTime
  dueAt             DateTime
  returnedAt        DateTime?
  depositMinor      Int
  feeMinor          Int
  status            RentalStatus
  customer          Customer     @relation(fields: [customerId], references: [id])

  @@index([status])
  @@index([dueAt])
}

enum RentalStatus {
  out
  returned
  overdue
  lost
}

model Event {
  id           String        @id @default(cuid())
  title        String
  startAt      DateTime
  capacity     Int
  squareItemId String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tickets      EventTicket[]

  @@index([startAt])
}

model EventTicket {
  id         String       @id @default(cuid())
  eventId    String
  orderId    String?
  customerId String?
  status     TicketStatus
  event      Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  order      Order?       @relation(fields: [orderId], references: [id])
  customer   Customer?    @relation(fields: [customerId], references: [id])

  @@index([eventId, status])
}

enum TicketStatus {
  held
  paid
  canceled
  refunded
}

model PaymentAttempt {
  id              String        @id @default(cuid())
  orderId         String
  method          PaymentMethod
  amountMinor     Int
  squarePaymentId String?
  status          PaymentStatus
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

enum PaymentMethod {
  square_terminal
  cash
}

enum PaymentStatus {
  initiated
  succeeded
  failed
  voided
}

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  kind      String
  payload   Json
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
}

model CatalogCache {
  id                String   @id @default(cuid())
  squareObjectId    String   @unique
  type              String
  version           BigInt
  data              Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([type])
}

model InventoryCount {
  id                String   @id @default(cuid())
  squareVariationId String   @unique
  locationId        String
  quantity          Int
  updatedAt         DateTime @updatedAt

  @@index([locationId])
}

model MenuCategory {
  id          String      @id @default(cuid())
  name        String
  nameJa      String?     // Japanese name
  description String?
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  items       MenuItem[]

  @@index([sortOrder])
}

model MenuItem {
  id                String              @id @default(cuid())
  categoryId        String?
  name              String
  nameJa            String?             // Japanese name
  description       String?
  customerPrice     Int                 // Price charged to customer in minor units (yen)
  costPrice         Int                 @default(0) // Total cost of ingredients in minor units
  quantity          String?             // e.g., "1 set", "300ml", "50g bag"
  isAvailable       Boolean             @default(true)
  sortOrder         Int                 @default(0)
  imageUrl          String?
  monthlySales      Int                 @default(0) // Monthly sales in units
  expectedWaste     Float               @default(0) // Expected waste percentage (0-100)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  category          MenuCategory?       @relation(fields: [categoryId], references: [id])
  ingredients       MenuItemIngredient[]
  
  @@index([categoryId])
  @@index([sortOrder])
}

model Ingredient {
  id                String              @id @default(cuid())
  name              String              @unique
  unit              String              // e.g., "g", "ml", "piece"
  costPerUnit       Int                 // Cost per unit in minor units
  stockQuantity     Float               @default(0)
  minStock          Float               @default(0)
  maxStock          Float?              // Maximum stock to maintain
  reorderPoint      Float?              // When to reorder
  reorderQuantity   Float?              // How much to reorder
  supplier          String?
  supplierSKU       String?             // Supplier's product code
  leadTimeDays      Int                 @default(1) // How long it takes to receive
  lastRestocked     DateTime?
  expiryDate        DateTime?
  notes             String?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  menuItems         MenuItemIngredient[]
  stockMovements    StockMovement[]
  purchaseOrders    PurchaseOrderItem[]

  @@index([name])
  @@index([stockQuantity])
}

model MenuItemIngredient {
  id           String      @id @default(cuid())
  menuItemId   String
  ingredientId String
  quantity     Float       // Amount of ingredient used
  isOptional   Boolean     @default(false) // For optional ingredients like flavoring
  menuItem     MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ingredient   Ingredient  @relation(fields: [ingredientId], references: [id])
  
  @@unique([menuItemId, ingredientId])
  @@index([menuItemId])
  @@index([ingredientId])
}

model StockMovement {
  id              String              @id @default(cuid())
  ingredientId    String
  type            StockMovementType
  quantity        Float               // Positive for additions, negative for removals
  unitCost        Int?                // Cost per unit at time of movement
  totalCost       Int?                // Total cost of this movement
  reason          String?             // e.g., "Purchase", "Sale", "Waste", "Adjustment"
  referenceId     String?             // e.g., orderId, purchaseOrderId
  referenceType   String?             // e.g., "order", "purchase_order", "adjustment"
  performedBy     String?             // userId who performed the movement
  notes           String?
  createdAt       DateTime            @default(now())
  ingredient      Ingredient          @relation(fields: [ingredientId], references: [id])
  
  @@index([ingredientId])
  @@index([type])
  @@index([createdAt])
  @@index([referenceId])
}

model Supplier {
  id              String              @id @default(cuid())
  name            String              @unique
  contactName     String?
  email           String?
  phone           String?
  address         String?
  website         String?
  paymentTerms    String?             // e.g., "Net 30", "Due on receipt"
  deliveryDays    String?             // e.g., "Mon, Wed, Fri"
  minimumOrder    Int?                // Minimum order amount in minor units
  notes           String?
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  purchaseOrders  PurchaseOrder[]
  
  @@index([name])
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique
  supplierId      String?
  supplierName    String              // Keep for backwards compatibility
  status          PurchaseOrderStatus @default(draft)
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  subtotal        Int                 @default(0) // in minor units
  tax             Int                 @default(0)
  shipping        Int                 @default(0)
  total           Int                 @default(0)
  notes           String?
  invoiceNumber   String?             // Supplier's invoice number
  paymentStatus   String?             // "pending", "paid", "partial"
  paymentDate     DateTime?
  createdBy       String?
  receivedBy      String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  supplier        Supplier?           @relation(fields: [supplierId], references: [id])
  items           PurchaseOrderItem[]
  
  @@index([status])
  @@index([orderDate])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id              String          @id @default(cuid())
  purchaseOrderId String
  ingredientId    String
  quantity        Float
  unitCost        Int             // Cost per unit in minor units
  totalCost       Int             // Total cost for this line item
  receivedQty     Float           @default(0)
  notes           String?
  purchaseOrder   PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  ingredient      Ingredient      @relation(fields: [ingredientId], references: [id])
  
  @@index([purchaseOrderId])
  @@index([ingredientId])
}

model Supply {
  id              String          @id @default(cuid())
  name            String          @unique
  category        String?         // e.g., "Packaging", "Cleaning", "Office"
  unit            String          // e.g., "pack", "box", "roll"
  costPerUnit     Int             // Cost per unit in minor units
  stockQuantity   Float           @default(0)
  minStock        Float           @default(0)
  maxStock        Float?
  reorderPoint    Float?
  reorderQuantity Float?
  supplier        String?
  supplierSKU     String?
  leadTimeDays    Int             @default(1)
  lastRestocked   DateTime?
  notes           String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([name])
  @@index([category])
}

model RetailItem {
  id              String          @id @default(cuid())
  name            String          @unique
  nameJa          String?         // Japanese name
  barcode         String?         @unique
  category        String?         // e.g., "Snacks", "Drinks", "Merchandise"
  costPrice       Int             // Purchase price in minor units
  retailPrice     Int             // Selling price in minor units
  stockQuantity   Float           @default(0)
  minStock        Float           @default(0)
  maxStock        Float?
  reorderPoint    Float?
  reorderQuantity Float?
  supplier        String?
  supplierSKU     String?
  imageUrl        String?
  description     String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([name])
  @@index([barcode])
  @@index([category])
}

model InventorySnapshot {
  id              String          @id @default(cuid())
  date            DateTime        @default(now())
  totalValue      Int             // Total inventory value in minor units
  itemCount       Int             // Number of different items
  lowStockItems   Int             // Number of items below reorder point
  outOfStockItems Int             // Number of items with 0 stock
  data            Json            // Detailed snapshot data
  createdAt       DateTime        @default(now())
  
  @@index([date])
}

enum StockMovementType {
  purchase        // Stock received from supplier
  sale            // Stock used in sales
  adjustment      // Manual adjustment
  waste           // Spoilage or damage
  transfer        // Transfer between locations
  return          // Return to supplier
  initial         // Initial stock count
}

enum PurchaseOrderStatus {
  draft
  sent
  partial
  received
  cancelled
}

enum GameType {
  board_game
  card_game
  party_game
  strategy_game
  cooperative_game
  dice_game
  rpg
  miniatures
  other
}

enum GameComplexity {
  easy
  medium
  hard
  expert
}


model Game {
  id             String          @id @default(cuid())
  name           String
  nameJa         String?         // Japanese name
  location       String          // Shelf number, storage location
  available      Boolean         @default(true)
  type           GameType        @default(board_game)
  minPlayers     Int             @default(1)
  maxPlayers     Int             @default(4)
  duration       Int             @default(60) // Typical play time in minutes
  complexity     GameComplexity  @default(medium)
  complexityJa   String?         // Japanese complexity description
  setupTime      Int             @default(10) // Minutes to set up
  description    String?         @db.Text
  descriptionJa  String?         @db.Text // Japanese description
  imageUrl       String?
  timesPlayed    Int             @default(0)
  
  // BGG Data
  bggId          Int?            // BoardGameGeek ID
  bggRating      Float?          // BGG average rating (1-10)
  bggWeight      Float?          // BGG complexity weight (1-5)
  yearPublished  Int?            // Year the game was published
  designer       String?         // Game designer(s)
  publisher      String?         // Game publisher(s)
  categories     String[]        // BGG categories (e.g., "Strategy", "Party")
  mechanics      String[]        // BGG mechanics (e.g., "Worker Placement")
  thumbnailUrl   String?         // Small image URL from BGG
  
  // Rental fields
  retailPrice    Int?            // Retail price for rental calculations
  isPremium      Boolean         @default(false) // Premium games incur extra fee
  maxRentalDays  Int?            // Maximum rental period (null = no limit)
  isRentable     Boolean         @default(false) // Is this game available for rental
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  tableSessions  TableGameSession[]
  rentals        GameRental[]
  
  @@index([name])
  @@index([available])
  @@index([type])
  @@index([complexity])
}

model TableGameSession {
  id         String      @id @default(cuid())
  tableId    String
  gameId     String
  startedAt  DateTime    @default(now())
  endedAt    DateTime?
  
  table      Table       @relation(fields: [tableId], references: [id])
  game       Game        @relation(fields: [gameId], references: [id])
  
  @@index([tableId])
  @@index([gameId])
  @@index([startedAt])
}

model GameRental {
  id                String       @id @default(cuid())
  customerId        String
  gameId            String
  checkOutDate      DateTime     @default(now())
  expectedReturnDate DateTime
  actualReturnDate  DateTime?
  checkOutPhotoUrl  String       // Required photo of game contents
  checkInPhotoUrl   String?      // Optional photo at return for damage
  depositAmount     Int          // Full retail value held as deposit
  baseFee           Int          // 10% of retail value
  nightlyFee        Int          // ¥100 per night
  premiumFee        Int          @default(0) // ¥1000 for premium games
  damageFee         Int          @default(0) // Added if damage occurs
  totalCharged      Int?         // Final amount charged
  paymentMethodId   String?      // Reference to stored payment method
  checkOutStaffId   String
  checkInStaffId    String?
  checkoutOrderId   String?      // Order created when checking out (deposit)
  returnOrderId     String?      // Order created when returning (charges)
  status            RentalStatus @default(out)
  notes             String?      @db.Text
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  customer          Customer     @relation(fields: [customerId], references: [id])
  game              Game         @relation(fields: [gameId], references: [id])
  checkOutStaff     User         @relation("CheckOutStaff", fields: [checkOutStaffId], references: [id])
  checkInStaff      User?        @relation("CheckInStaff", fields: [checkInStaffId], references: [id])
  checkoutOrder     Order?       @relation("RentalCheckoutOrder", fields: [checkoutOrderId], references: [id])
  returnOrder       Order?       @relation("RentalReturnOrder", fields: [returnOrderId], references: [id])
  
  @@index([customerId])
  @@index([gameId])
  @@index([status])
  @@index([checkOutDate])
  @@index([expectedReturnDate])
}

// Employee Management Models

enum PayType {
  hourly
  salary
}

model EmployeeProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Info
  phoneNumber       String?
  emergencyContact  String?
  emergencyPhone    String?
  address           String?
  
  // Pay Information
  payType           PayType  @default(hourly)
  payRate           Int      // in minor units (yen)
  hourlyRate        Float?   // hourly rate in yen (major units)
  overtimeRate      Int?     // typically 125% of regular rate
  nightRate         Int?     // typically 135% of regular rate
  
  // Tax Info (Japan-specific)
  socialInsuranceNo String?  // 社会保険番号
  taxWithholding    Int?     // 源泉徴収税額
  dependents        Int      @default(0)
  
  // Benefits
  paidTimeOff       Float    @default(0) // in days
  sickDays          Float    @default(0) // in days
  
  // Banking
  bankName          String?
  bankBranch        String?
  accountNumber     String?  // Should be encrypted in production
  accountName       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
}

enum TimeEntryStatus {
  active
  adjusted
  approved
  disputed
}

model TimeEntry {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation(fields: [userId], references: [id])
  
  clockIn      DateTime
  clockOut     DateTime?
  breakStart   DateTime?
  breakEnd     DateTime?
  
  // Calculated fields (in hours)
  regularHours Float           @default(0)
  overtimeHours Float          @default(0)
  nightHours   Float           @default(0) // 22:00-05:00 in Japan
  totalHours   Float           @default(0)
  
  // Admin adjustments
  adjustedById String?         // userId who made adjustment
  adjustedBy   User?           @relation("AdjustedBy", fields: [adjustedById], references: [id])
  adjustNote   String?         // Reason for adjustment
  originalIn   DateTime?       // Store original if edited
  originalOut  DateTime?       // Store original if edited
  
  status       TimeEntryStatus @default(active)
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@index([userId, clockIn])
  @@index([status])
}